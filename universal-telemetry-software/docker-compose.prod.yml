services:
  telemetry:
    image: ghcr.io/western-formula-racing/universal-telemetry:latest
    container_name: daq-telemetry
    privileged: true
    restart: unless-stopped
    ports:
      - "5005:5005/udp" # UDP CAN data
      - "5006:5006/tcp" # TCP retransmission
      - "8080:8080/tcp" # Status HTTP server
      - "9080:9080/tcp" # WebSocket for PECAN
    environment:
      - ROLE=auto # auto, car, or base
      - REMOTE_IP=192.168.1.100 # IP of the other RPi
      - UDP_PORT=5005
      - TCP_PORT=5006
      - REDIS_URL=redis://redis:6379/0 # Use service name
      - WS_PORT=9080 # WebSocket for PECAN dashboard
      - STATUS_PORT=8080 # HTTP server for status page
      - SIMULATE=true # Set to true for simulation mode
      - ENABLE_VIDEO=false # Enable video streaming
      - ENABLE_AUDIO=false # Enable audio streaming
    volumes:
      - /lib/modules:/lib/modules # In case CAN drivers are needed
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - redis

  redis:
    image: redis:8.2
    container_name: daq-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  pecan:
    image: ghcr.io/western-formula-racing/pecan:latest
    container_name: daq-pecan
    restart: unless-stopped
    ports:
      - "3000:80" # Pecan dashboard UI
    depends_on:
      - telemetry

  # Voice Communication Services
  murmur:
    image: mumblevoip/mumble-server:latest
    container_name: daq-murmur
    restart: unless-stopped
    ports:
      - "64738:64738/tcp" # Mumble TCP
      - "64738:64738/udp" # Mumble UDP
    environment:
      - MUMBLE_SUPERUSER_PASSWORD=wfr2025
      - MUMBLE_CONFIG_WELCOMETEXT=Welcome to WFR Comms!
      - MUMBLE_CONFIG_REGISTERPASSWORD=
      - MUMBLE_CONFIG_ALLOWPING=true
    volumes:
      - murmur_data:/data

  mumble-web:
    image: rankenstein/mumble-web:latest
    container_name: daq-mumble-web
    restart: unless-stopped
    ports:
      - "8088:8080" # Web client with websockify (internal 8080)
    environment:
      - MUMBLE_SERVER=murmur:64738
    depends_on:
      - murmur

volumes:
  redis_data:
  murmur_data:
